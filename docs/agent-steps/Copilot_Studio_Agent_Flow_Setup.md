# Copilot Studio Agent Flow Setup Guide

## Setup Steps

| Step | Description | Screenshot |
|------|-------------|------------|
| 1 | Click on the **Flows** tab (left sidebar). | ![step-1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-1.png) |
| 2 | Click on **New agent flow**. | ![step-2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-2.png) |
| 3 | Add the **When an agent calls the flow** trigger. | ![step-3](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-3.png) |
| 4 | Add **Initialize Variable** actions for:<br>- **Space-ID** (User needs to fill the Space ID of the Databricks Genie)<br>- **Token** (User needs to fill the PAT Token of Databricks)<br>- **Text Output** (stores text output from Databricks Genie - initial value to be left empty)<br>- **Inline Data** (stores query results for visualization - initial value to be left empty) | ![step-4](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-4.png) |
| 5 | Add an action to send an HTTP **POST** request to the Databricks Genie API to start the conversation:<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/start-conversation`<br>- **Header:** `Authorization: Bearer <Token variable>`<br>- **Body:** JSON with `content: User Query` | ![step-5.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-5.1.png)<br>![step-5.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-5.2.png) |
| 6 | Add an action to send an HTTP **GET** request to Databricks Genie API to get the status of the conversation message (use `conversation_id` and `message_id` from previous step):<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/conversations/<conversation_id>/messages/<message_id>`<br>- **Header:** `Authorization: Bearer <Token variable>` | ![step-6](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-6.png) |
| 7 | Add **Initialize Variable** action to store the status of the conversation message. | ![step-7](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-7.png) |
| 8 | Add an action to send an HTTP **GET** request to Databricks Genie API to get the status of the conversation message every 5 seconds until the status is **SUCCEEDED**: <br>&nbsp;&nbsp;&nbsp;1. Add a **Do until** action to check the status. <br>&nbsp;&nbsp;&nbsp;2. Inside the **Do until** action, add a **Delay** action (not **Delay until** action) to keep a delay of 5 seconds between the pings. <br>&nbsp;&nbsp;&nbsp;3. Add a **HTTP** action from the HTTP section to send the get request from the Genie Conversation API using the following details:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/conversations/<conversation_id>/messages/<message_id>`<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- **Header:** `Authorization: Bearer <Token variable>`<br>&nbsp;&nbsp;&nbsp;4. Add a **Set Variable** action to update the Status variable with the current value of HTTP action. <br>&nbsp;&nbsp;&nbsp;5. Update the until part with **Status** is equal to COMPLETED. | ![step-8.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-8.1.png)<br>![step-8.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-8.2.png)![step-8.3](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-8.3.png)<br>![step-8.4](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-8.4.png) |
| 9 | Add an action to send an HTTP **GET** request to Databricks Genie API to get the message content:<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/conversations/<conversation_id>/messages/<message_id>`<br>- **Header:** `Authorization: Bearer <Token variable>` | ![step-9](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-9.png) |
| 10 | We get 2 types of message content from the Genie API: text and query. For simplicity, we are focusing only on the **text** part and will be just passing the **query** as is to the user. <br>&nbsp;&nbsp;&nbsp;1. Add an **Apply to each** action to iterate over the message contents fetched from the Databricks Genie API. <br>&nbsp;&nbsp;&nbsp;2. Add a **Compose** action for storing the result of the conditional statement as mentioned in the screenshot <br>&nbsp;&nbsp;&nbsp;3. Add a **Switch** action that checks the output of the previous Compose action. <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- If the message content type is **text**, store it in the **Text Output** variable by adding an **Append variable** action. <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- If the message content type is **query**, store it in the **Inline Data** variable by adding a **Set variable** action. | ![step-10.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.1.png)<br>![step-10.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.2.png)<br>![step-10.3](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.3.png)<br>![step-10.4](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.4.png)<br>![step-10.5](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.5.png) |
| 11 | Respond with a structured JSON output to the Agent containing **User Query**, **Text Output**, and **Inline Data**. | ![step-11](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-11.png) |
| 12 | Click on **Save draft** and then **Publish**. | ![step-12](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-12.png) |

