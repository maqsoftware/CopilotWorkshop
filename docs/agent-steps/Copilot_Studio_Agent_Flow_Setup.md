# Copilot Studio Agent Flow Setup Guide

## Setup Steps

| Step | Description | Screenshot |
|------|-------------|------------|
| 1 | Click on the **Flows** tab (left sidebar). | ![step-1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-1.png) |
| 2 | Click on **New agent flow**. | ![step-2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-2.png) |
| 3 | Add the **When an agent calls the flow** trigger. | ![step-3](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-3.png) |
| 4 | Add **Initialize Variable** actions for:<br>- **Space-ID** (User needs to fill the Space ID of the Databricks Genie)<br>- **Token** (User needs to fill the PAT Token of Databricks)<br>- **Text Output** (stores text output from Databricks Genie - initial value to be left empty)<br>- **Inline Data** (stores query results for visualization - initial value to be left empty) | ![step-4](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-4.png) |
| 5 | Add an action to send an HTTP **POST** request to the Databricks Genie API to start the conversation:<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/start-conversation`<br>- **Header:** `Authorization: Bearer <Token variable>`<br>- **Body:** JSON with `content: User Query` | ![step-5.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-5.1.png)<br>![step-5.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-5.2.png) |
| 6 | Add an action to send an HTTP **GET** request to Databricks Genie API to get the status of the conversation message (use `conversation_id` and `message_id` from previous step):<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/conversations/<conversation_id>/messages/<message_id>`<br>- **Header:** `Authorization: Bearer <Token variable>` | ![step-6](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-6.png) |
| 7 | Add **Initialize Variable** action to store the status of the conversation message. | ![step-7](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-7.png) |
| 8 | Add an action to send an HTTP **GET** request to Databricks Genie API to get the status of the conversation message every 5 seconds until the status is **SUCCEEDED** (add a Do until action to check the status):<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/conversations/<conversation_id>/messages/<message_id>`<br>- **Header:** `Authorization: Bearer <Token variable>` | ![step-8.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-8.1.png)<br>![step-8.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-8.2.png) |
| 9 | Add an action to send an HTTP **GET** request to Databricks Genie API to get the message content:<br>- **URL:** `<Your Databricks endpoint>/api/2.0/genie/spaces/<Space-ID>/conversations/<conversation_id>/messages/<message_id>`<br>- **Header:** `Authorization: Bearer <Token variable>` | ![step-9](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-9.png) |
| 10 | Iterate over the message contents fetched from the Databricks Genie API by using an  **Apply to each** action (We get 2 types of message content from the Genie API: text and query. For simplicity, we are focusing only on the **text** part by using a **Switch** action.):<br>- If the message content type is **text**, store it in the **Text Output** variable. | ![step-10.1.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.1.1.png)<br>![step-10.1.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.1.2.png)<br>![step-10.2.1](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.2.1.png)<br>![step-10.2.2](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-10.2.2.png) |
| 11 | Respond with a structured JSON output to the Agent containing **User Query**, **Text Output**, and **Inline Data**. | ![step-11](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-11.png) |
| 12 | Click on **Save draft** and then **Publish**. | ![step-12](../../screenshots/Copilot_Studio_Agent_Flow_Setup/step-12.png) |

